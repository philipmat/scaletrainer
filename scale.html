<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Scale Trainer </title>
	<!--script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script-->
	<script type="text/javascript" src="lib/knockout-3.2.0.js"></script>
	<script type="text/javascript" src="main.js"></script>
	<style>
	.octave-note {
		border: 4px solid silver;
		padding: 24px;
		font-size: 2em;
	}
	.current { border: 4px solid green; }
	.past { border: 4px solid blue; }


	</style>
</head>
<body>
<div style="display: none" data-bind="visible: $data">
	<p>&nbsp;</p>
	<div id="scale-display" data-bind="foreach: notes">
		<span class="octave-note"><span class="note" data-bind="text: note">(note)</span><span class="octave" data-bind="text: octave">(8ve)</span></span>
	</div>
	<button data-bind="visible: next_visible, click: move_next">Next</button>
</div>

<script type="text/coffeescript" src="scale.coffee"></script>
<script type="text/coffeescript">
$id = (id) ->
	document.getElementById id
$class = (id) ->
	Array.prototype.slice.call document.getElementsByClassName id

S = window['scale']

keys = ['instrument', 'mode', 'key', 'measures', 'time', 'bpm', 'randomness', 'autoadvance']
model =
	current_note: 0
	next_visible: ko.observable(false)
	move_next: () ->
		window.location.reload()
	advance: () ->
		if model.autoadvance == 'on'
			model.move_next()
		else
			model.next_visible(true)
	highlight: () ->
		note = model.current_note + 1
		console.log 'highlight', note, model.number_of_notes
		if note >= model.number_of_notes
			$class('octave-note')[model.number_of_notes-1].className = 'octave-note past'
			window.clearInterval timer
			model.advance()
			return
		# clear previous
		notes = $class('octave-note')
		for n, i in notes
			if i < note
				n.className = 'octave-note past'
			if i == note
				n.className = 'octave-note current'
		
		model.current_note = note
		
for k in keys
	model[k] = getParameterByName k
	
model.number_of_notes = 4
model.note_time = 60 * 1000 / model.bpm

scale_in_key = S.scale model.key, model.mode
instrument_scale = S.instrument_scale model.instrument, scale_in_key
model.notes = ko.observableArray S.random_notes instrument_scale, model.number_of_notes

console.log model
model.loaded = true
ko.applyBindings model
	
model.current_note = -1
timer = window.setInterval model.highlight, model.note_time

</script>
<!--script type="text/javascript" src="https://rawgit.com/jashkenas/coffeescript/master/extras/coffee-script.js"></script-->
<script type="text/javascript" src="lib/coffee-script.js"></script>
</body>
</html>
